{% extends "base.html" %}

{% block title %}Mark Attendance{% endblock %}

{% block extra_css %}
<style>
    #video-container {
        position: relative;
        max-width: 640px;
        margin: 2rem auto;
    }
    
    #video-feed {
        width: 100%;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    }
    
    .attendance-btn {
        width: 100%;
        margin-top: 0.5rem;
        font-size: 1.2rem;
        padding: 1rem;
    }
    
    .btn-group {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .btn-group button {
        flex: 1;
    }
    
    #status-info {
        background: #f0f4ff;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        text-align: center;
    }
    
    #liveness-status {
        background: #fff3cd;
        border: 2px solid #ffc107;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem auto;
        max-width: 400px;
        text-align: center;
    }
    
    #liveness-status.verified {
        background: #d4edda;
        border-color: #28a745;
    }
    
    .blink-indicator {
        font-size: 1.5rem;
        font-weight: bold;
        color: #ffc107;
    }
    
    .blink-indicator.verified {
        color: #28a745;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <h2 style="color: #667eea; text-align: center; margin-bottom: 1rem;">Mark Your Attendance</h2>
    <p style="text-align: center; color: #666; margin-bottom: 1rem;">
        Check in at the start of class and check out when leaving
    </p>
    
    <div id="liveness-status">
        <p style="margin: 0;">
            üëÅÔ∏è <strong>Liveness Detection Active</strong><br>
            <small>Please blink naturally to verify you're a real person</small>
        </p>
        <p class="blink-indicator" id="blink-count">Blinks: 0</p>
    </div>
    
    <div class="form-group" style="max-width: 400px; margin: 0 auto 2rem;">
        <label for="course_code">Select Course</label>
        <select id="course_code" name="course_code" required>
            <option value="">-- Select a Course --</option>
            {% for course in courses %}
            <option value="{{ course['course_code'] }}">
                {{ course['course_code'] }} - {{ course['course_name'] }} 
                (Min: {{ course['min_duration_minutes'] }} mins)
            </option>
            {% endfor %}
        </select>
    </div>
    
    <div id="status-info" style="display:none;">
        <p id="status-text"></p>
    </div>
    
    <div id="video-container">
        <img id="video-feed" src="{{ url_for('video_feed') }}" alt="Camera Feed">
        <div class="btn-group">
            <button id="checkin-btn" class="btn btn-success attendance-btn" onclick="captureAttendance('check_in')">
                ‚úÖ Check In
            </button>
            <button id="checkout-btn" class="btn btn-primary attendance-btn" onclick="captureAttendance('check_out')">
                üö™ Check Out
            </button>
        </div>
    </div>
    
    <div id="result-message" style="margin-top: 2rem; text-align: center;"></div>
</div>

<script>
    // Track blinks detected from video feed
    let blinkCount = 0;
    let isLivenessVerified = false;
    
    // Poll backend for blink count
    setInterval(() => {
        fetch('/get-blink-count')
            .then(response => response.json())
            .then(data => {
                updateLivenessStatus(data.blink_count);
            })
            .catch(error => {
                console.error('Error fetching blink count:', error);
            });
    }, 500);  // Poll every 500ms
    
    // Update liveness status display
    function updateLivenessStatus(blinks) {
        blinkCount = blinks;
        const blinkCountEl = document.getElementById('blink-count');
        const livenessStatusEl = document.getElementById('liveness-status');
        
        blinkCountEl.textContent = `Blinks: ${blinks}`;
        
        if (blinks >= 1) {
            isLivenessVerified = true;
            livenessStatusEl.classList.add('verified');
            blinkCountEl.classList.add('verified');
            blinkCountEl.textContent = `‚úì Verified (${blinks} blink${blinks > 1 ? 's' : ''})`;
        } else {
            isLivenessVerified = false;
            livenessStatusEl.classList.remove('verified');
            blinkCountEl.classList.remove('verified');
        }
    }
    

    
    function captureAttendance(action) {
        const courseCode = document.getElementById('course_code').value;
        const resultDiv = document.getElementById('result-message');
        
        if (!courseCode) {
            resultDiv.innerHTML = '<div class="alert alert-error">Please select a course first</div>';
            return;
        }
        
        // Disable buttons during capture
        const checkinBtn = document.getElementById('checkin-btn');
        const checkoutBtn = document.getElementById('checkout-btn');
        const originalText = action === 'check_in' ? checkinBtn.textContent : checkoutBtn.textContent;
        const activeBtn = action === 'check_in' ? checkinBtn : checkoutBtn;
        
        checkinBtn.disabled = true;
        checkoutBtn.disabled = true;
        activeBtn.textContent = 'Verifying...';
        
        fetch('/capture-attendance', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                course_code: courseCode,
                action: action,
                blink_count: blinkCount  // Send current blink count
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let statusClass = 'alert-success';
                let statusIcon = '‚úÖ';
                
                if (data.action === 'check_out') {
                    if (data.status === 'Present') {
                        statusIcon = '‚úÖ';
                        statusClass = 'alert-success';
                    } else {
                        statusIcon = '‚ö†Ô∏è';
                        statusClass = 'alert-warning';
                    }
                }
                
                resultDiv.innerHTML = `
                    <div class="alert ${statusClass}">
                        <h3>${statusIcon} ${data.message}</h3>
                        <p><strong>Student:</strong> ${data.student_name} (${data.student_id})</p>
                        <p><strong>Confidence:</strong> ${data.confidence}</p>
                    </div>
                `;
                
                // Update status info
                const statusInfo = document.getElementById('status-info');
                const statusText = document.getElementById('status-text');
                if (data.action === 'check_in') {
                    statusInfo.style.display = 'block';
                    statusText.innerHTML = '<strong>Status:</strong> Checked In - Remember to check out before leaving!';
                } else if (data.action === 'check_out') {
                    statusInfo.style.display = 'block';
                    statusText.innerHTML = `<strong>Final Status:</strong> ${data.status}`;
                }
            } else {
                let alertClass = 'alert-error';
                let message = data.message;
                
                // Special handling for liveness check failure
                if (data.liveness_required) {
                    alertClass = 'alert-warning';
                    message = '‚ö†Ô∏è ' + message + '<br><small>Keep looking at the camera and blink naturally</small>';
                }
                
                if (data.can_checkout) {
                    alertClass = 'alert-info';
                }
                
                if (data.student_name) {
                    message += `<br><strong>Recognized:</strong> ${data.student_name} (${data.student_id})`;
                }
                
                if (data.status) {
                    message += `<br><strong>Status:</strong> ${data.status}`;
                }
                
                resultDiv.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
            }
        })
        .catch(error => {
            resultDiv.innerHTML = '<div class="alert alert-error">Error capturing attendance. Please try again.</div>';
        })
        .finally(() => {
            checkinBtn.disabled = false;
            checkoutBtn.disabled = false;
            activeBtn.textContent = originalText;
        });
    }

</script>
{% endblock %}
